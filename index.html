<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanafi Livraison</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles pour la banni√®re d'installation -->
    <style>
        #installBanner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
        }
        
        #installBanner button {
            background: white;
            color: #007bff;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #installBanner .close {
            background: transparent;
            color: white;
            border: 1px solid white;
        }
        
        .install-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        /* Styles existants de votre app */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        #map {
            width: 100%;
            height: 100vh;
            display: none;
        }

        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: none;
            gap: 10px;
        }

        #searchInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
        }

        #clearSearch {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: none;
        }

        #routeSummary {
            position: fixed;
            top: 60px;
            left: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
            display: none;
        }

        #logoutBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }

        #logoutBtn:hover {
            background: #c82333;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Banni√®re d'installation APK -->
    <div id="installBanner">
        <div>
            <span class="install-icon">üì±</span>
            <strong>Installer l'application Hanafi Livraison</strong>
            <br>
            <small>Pour une meilleure exp√©rience et utilisation hors ligne</small>
        </div>
        <div style="margin-top: 10px;">
            <button id="installButton">‚úÖ Installer</button>
            <button id="closeBanner" class="close">‚ùå Plus tard</button>
        </div>
    </div>

    <!-- Votre contenu existant -->
    <div id="loginContainer" class="container">
        <h2 style="text-align: center; color: #333;">Hanafi Livraison</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Mot de passe" required>
        <button id="loginBtn">Se connecter</button>
        <div id="loginError" class="error"></div>
    </div>

    <div id="map"></div>

    <div id="controls">
        <input type="text" id="searchInput" placeholder="üîç Rechercher un client...">
        <button id="clearSearch">‚úï</button>
    </div>

    <div id="routeSummary"></div>

    <button id="logoutBtn">D√©connexion</button>

    <script>
        // ===========================================================
        // GESTION DE L'INSTALLATION AUTOMATIQUE APK
        // ===========================================================
        
        // URL de t√©l√©chargement de votre APK (√† modifier avec votre vraie URL)
        const APK_DOWNLOAD_URL = 'https://github.com/nassimpublishing-dz/Hanafi-Map/releases/latest/download/app-release.apk';
        
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');
        const closeBanner = document.getElementById('closeBanner');

        // D√©tecter si l'app est d√©j√† install√©e
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        // V√©rifier si on est sur mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Afficher la banni√®re d'installation
        function showInstallBanner() {
            if (isMobileDevice() && !isAppInstalled()) {
                console.log('üì± Affichage banni√®re installation');
                installBanner.style.display = 'block';
                
                // Masquer automatiquement apr√®s 30 secondes
                setTimeout(() => {
                    if (installBanner.style.display === 'block') {
                        installBanner.style.display = 'none';
                        localStorage.setItem('installBannerShown', 'true');
                    }
                }, 30000);
            }
        }

        // √âv√©nement pour l'installation PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéØ Installation PWA disponible');
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        // Installation PWA
        installButton.addEventListener('click', async () => {
            console.log('üîÑ D√©but installation');
            
            if (deferredPrompt) {
                // Installation PWA standard
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('‚úÖ PWA install√©e avec succ√®s');
                        installBanner.style.display = 'none';
                        localStorage.setItem('installBannerShown', 'true');
                    } else {
                        console.log('‚ùå Installation PWA annul√©e');
                        downloadAPK(); // Fallback vers APK
                    }
                } catch (error) {
                    console.error('Erreur installation PWA:', error);
                    downloadAPK(); // Fallback vers APK
                }
                deferredPrompt = null;
            } else {
                // Fallback : t√©l√©chargement APK
                downloadAPK();
            }
        });

        // T√©l√©chargement de l'APK
        function downloadAPK() {
            console.log('üì¶ D√©but du t√©l√©chargement APK');
            
            // Cr√©er un lien de t√©l√©chargement
            const link = document.createElement('a');
            link.href = APK_DOWNLOAD_URL;
            link.download = 'Hanafi-Livraison.apk';
            link.target = '_blank';
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Message de confirmation
            alert('üì± T√©l√©chargement de l\'APK commenc√© !\n\nUne fois t√©l√©charg√© :\n1. Ouvrez le fichier .apk\n2. Autorisez l\'installation\n3. Lancez l\'application');
            
            // Masquer la banni√®re
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerShown', 'true');
        }

        // Fermer la banni√®re
        closeBanner.addEventListener('click', () => {
            console.log('‚ùå Banni√®re ferm√©e');
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerShown', 'true');
            
            // Re-proposer dans 7 jours
            const nextShow = new Date();
            nextShow.setDate(nextShow.getDate() + 7);
            localStorage.setItem('nextInstallPrompt', nextShow.getTime());
        });

        // V√©rifier si on doit afficher la banni√®re
        function shouldShowBanner() {
            const bannerShown = localStorage.getItem('installBannerShown');
            const nextPrompt = localStorage.getItem('nextInstallPrompt');
            
            if (bannerShown === 'true' && nextPrompt) {
                const now = new Date().getTime();
                return now >= parseInt(nextPrompt);
            }
            
            return bannerShown !== 'true';
        }

        // D√©tection de l'installation r√©ussie
        window.addEventListener('appinstalled', () => {
            console.log('üéâ Application install√©e avec succ√®s !');
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerShown', 'true');
        });

        // Initialisation au chargement
        window.addEventListener('load', () => {
            console.log('üöÄ Application charg√©e - V√©rification installation');
            
            if (isMobileDevice() && !isAppInstalled() && shouldShowBanner()) {
                // Afficher apr√®s 3 secondes
                setTimeout(showInstallBanner, 3000);
            }
            
            // Si pas de banni√®re PWA apr√®s 5 secondes, proposer l'APK
            setTimeout(() => {
                if (isMobileDevice() && !isAppInstalled() && !deferredPrompt && shouldShowBanner()) {
                    console.log('üì± Aucune PWA disponible - Proposition APK');
                    showInstallBanner();
                }
            }, 5000);
        });

        // Fonction pour forcer l'affichage de la banni√®re (pour tests)
        window.showInstallPrompt = function() {
            showInstallBanner();
        };
    </script>

    <!-- Configuration Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC0XcVxZ6v9v8q8Q6b6r9K5jM8wXx7vF8d",
            authDomain: "hanafi-livraison.firebaseapp.com",
            databaseURL: "https://hanafi-livraison-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hanafi-livraison",
            storageBucket: "hanafi-livraison.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };
        
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
    </script>

    <!-- Vos scripts existants -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="app.js"></script>
</body>
</html>
