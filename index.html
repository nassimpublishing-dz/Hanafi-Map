<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanafi Livraison</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- D√©sactiver les features exp√©rimentales pour √©viter les erreurs -->
    <meta http-equiv="Permissions-Policy" content="browsing-topics=(), run-ad-auction=(), join-ad-interest-group=(), private-state-token-redemption=(), private-state-token-issuance=(), private-aggregation=(), attribution-reporting=(), compute-pressure=()">
    
    <!-- Styles pour la banni√®re d'installation -->
    <style>
        #installBanner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
        }
        
        #installBanner button {
            background: white;
            color: #007bff;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #installBanner .close {
            background: transparent;
            color: white;
            border: 1px solid white;
        }
        
        .install-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        /* Styles pour la modale de t√©l√©chargement */
        #downloadModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10001;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #downloadModal .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #downloadModal h3 {
            color: #007bff;
            margin-bottom: 15px;
        }

        #downloadModal .steps {
            text-align: left;
            margin: 20px 0;
        }

        #downloadModal .step {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }

        #downloadModal .step-number {
            background: #007bff;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
            font-weight: bold;
        }

        #downloadModal .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        #downloadModal .progress {
            width: 0%;
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }

        /* Styles existants de votre app */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        #map {
            width: 100%;
            height: 100vh;
            display: none;
        }

        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: none;
            gap: 10px;
        }

        #searchInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
        }

        #clearSearch {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: none;
        }

        #routeSummary {
            position: fixed;
            top: 60px;
            left: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
            display: none;
        }

        #logoutBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }

        #logoutBtn:hover {
            background: #c82333;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Banni√®re d'installation APK -->
    <div id="installBanner">
        <div>
            <span class="install-icon">üì±</span>
            <strong>Installer l'application Hanafi Livraison</strong>
            <br>
            <small>Pour une meilleure exp√©rience et utilisation hors ligne</small>
        </div>
        <div style="margin-top: 10px;">
            <button id="installButton">‚úÖ Installer</button>
            <button id="closeBanner" class="close">‚ùå Plus tard</button>
        </div>
    </div>

    <!-- Modale de t√©l√©chargement automatique -->
    <div id="downloadModal">
        <div class="modal-content">
            <div style="font-size: 48px; margin-bottom: 15px;">üöö</div>
            <h3>Installation Hanafi Livraison</h3>
            
            <div class="progress-bar">
                <div class="progress" id="downloadProgress"></div>
            </div>
            
            <div id="downloadStatus">Pr√©paration du t√©l√©chargement...</div>
            
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div>T√©l√©chargement automatique</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div>Installation de l'APK</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div>Lancement de l'app</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: none;" id="manualDownload">
                <p style="color: #dc3545; font-size: 14px;">
                    Le t√©l√©chargement automatique a √©chou√©. 
                    <a href="#" id="manualLink" style="color: #007bff;">Cliquez ici pour t√©l√©charger manuellement</a>
                </p>
            </div>
            
            <button id="closeModal" style="background: #6c757d; margin-top: 15px;">Fermer</button>
        </div>
    </div>

    <!-- Votre contenu existant -->
    <div id="loginContainer" class="container">
        <h2 style="text-align: center; color: #333;">Hanafi Livraison</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Mot de passe" required>
        <button id="loginBtn">Se connecter</button>
        <div id="loginError" class="error"></div>
    </div>

    <div id="map"></div>

    <div id="controls">
        <input type="text" id="searchInput" placeholder="üîç Rechercher un client...">
        <button id="clearSearch">‚úï</button>
    </div>

    <div id="routeSummary"></div>

    <button id="logoutBtn">D√©connexion</button>

    <!-- Charger Firebase EN PREMIER -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // ===========================================================
        // CONFIGURATION FIREBASE - DOIT √äTRE AVANT TOUT
        // ===========================================================
        const firebaseConfig = {
            // ‚ö†Ô∏è REMPLACEZ PAR VOS VRAIES CL√âS FIREBASE
            apiKey: "AIzaSyC0XcVxZ6v9v8q8Q6b6r9K5jM8wXx7vF8d",
            authDomain: "hanafi-livraison.firebaseapp.com",
            databaseURL: "https://hanafi-livraison-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hanafi-livraison",
            storageBucket: "hanafi-livraison.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };
        
        // Initialiser Firebase IMM√âDIATEMENT
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase initialis√© avec succ√®s');
        } catch (error) {
            console.error('‚ùå Erreur initialisation Firebase:', error);
        }
    </script>

    <script>
        // ===========================================================
        // SYST√àME DE T√âL√âCHARGEMENT AUTOMATIQUE INT√âGR√â
        // ===========================================================
        
        // URLs de t√©l√©chargement avec fallbacks
        const APK_URLS = [
            'https://github.com/nassimpublishing-dz/Hanafi-Map/releases/latest/download/app-release.apk',
            'https://github.com/nassimpublishing-dz/Hanafi-Map/releases/download/v2.0/app-release.apk',
            '/Hanafi-Map/hanafi-livraison.apk'
        ];
        
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');
        const closeBanner = document.getElementById('closeBanner');
        const downloadModal = document.getElementById('downloadModal');
        const downloadProgress = document.getElementById('downloadProgress');
        const downloadStatus = document.getElementById('downloadStatus');
        const manualDownload = document.getElementById('manualDownload');
        const manualLink = document.getElementById('manualLink');
        const closeModal = document.getElementById('closeModal');

        // D√©tecter si l'app est d√©j√† install√©e
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        // V√©rifier si on est sur mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Afficher la banni√®re d'installation
        function showInstallBanner() {
            if (isMobileDevice() && !isAppInstalled()) {
                console.log('üì± Affichage banni√®re installation');
                installBanner.style.display = 'block';
                
                // Masquer automatiquement apr√®s 30 secondes
                setTimeout(() => {
                    if (installBanner.style.display === 'block') {
                        installBanner.style.display = 'none';
                        localStorage.setItem('installBannerShown', 'true');
                    }
                }, 30000);
            }
        }

        // √âv√©nement pour l'installation PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéØ Installation PWA disponible');
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        // Installation PWA
        installButton.addEventListener('click', async () => {
            console.log('üîÑ D√©but installation');
            
            if (deferredPrompt) {
                // Installation PWA standard
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('‚úÖ PWA install√©e avec succ√®s');
                        installBanner.style.display = 'none';
                        localStorage.setItem('installBannerShown', 'true');
                        showTempNotification('üéâ Application install√©e !', 3000);
                    } else {
                        console.log('‚ùå Installation PWA annul√©e');
                        startAutomaticDownload(); // Fallback vers APK automatique
                    }
                } catch (error) {
                    console.error('Erreur installation PWA:', error);
                    startAutomaticDownload(); // Fallback vers APK automatique
                }
                deferredPrompt = null;
            } else {
                // Fallback : t√©l√©chargement APK automatique
                startAutomaticDownload();
            }
        });

        // SYST√àME DE T√âL√âCHARGEMENT AUTOMATIQUE
        function startAutomaticDownload() {
            console.log('üöÄ Lancement du t√©l√©chargement automatique');
            
            // Masquer la banni√®re
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerShown', 'true');
            
            // Afficher la modale
            downloadModal.style.display = 'flex';
            downloadStatus.textContent = 'Initialisation...';
            downloadProgress.style.width = '0%';
            manualDownload.style.display = 'none';
            
            // D√©marrer la s√©quence de t√©l√©chargement
            simulateDownloadProcess();
        }

        function simulateDownloadProcess() {
            let progress = 0;
            const steps = [
                'Connexion au serveur...',
                'V√©rification de la version...',
                'T√©l√©chargement de l\'APK...',
                'Pr√©paration de l\'installation...',
                'Presque termin√©...'
            ];
            
            let currentStep = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                downloadProgress.style.width = progress + '%';
                downloadStatus.textContent = steps[currentStep];
                
                // Passer √† l'√©tape suivante
                if (progress >= (currentStep + 1) * 20 && currentStep < steps.length - 1) {
                    currentStep++;
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    completeDownloadProcess();
                }
            }, 400);
        }

        function completeDownloadProcess() {
            downloadStatus.textContent = 'T√©l√©chargement termin√© !';
            
            // Simuler un d√©lai avant la redirection
            setTimeout(() => {
                // Essayer le t√©l√©chargement r√©el
                attemptRealDownload();
            }, 1500);
        }

        function attemptRealDownload() {
            // Essayer chaque URL jusqu'√† ce qu'une fonctionne
            tryAllDownloadUrls(0);
        }

        function tryAllDownloadUrls(index) {
            if (index >= APK_URLS.length) {
                // Toutes les URLs ont √©chou√©
                showManualDownloadOption();
                return;
            }
            
            const currentUrl = APK_URLS[index];
            console.log('üîó Essai URL:', currentUrl);
            
            downloadStatus.textContent = `Tentative de t√©l√©chargement... (${index + 1}/${APK_URLS.length})`;
            
            // Cr√©er un lien invisible pour le t√©l√©chargement
            const link = document.createElement('a');
            link.href = currentUrl;
            link.download = 'Hanafi-Livraison.apk';
            link.style.display = 'none';
            
            // V√©rifier si le lien est valide
            fetch(currentUrl, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        // URL valide - d√©clencher le t√©l√©chargement
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        downloadStatus.innerHTML = '‚úÖ <strong>T√©l√©chargement r√©ussi !</strong><br>V√©rifiez vos notifications.';
                        
                        // Fermer automatiquement apr√®s 3 secondes
                        setTimeout(() => {
                            downloadModal.style.display = 'none';
                            showTempNotification('üì± T√©l√©chargement APK termin√© !', 3000);
                        }, 3000);
                    } else {
                        // Essayer l'URL suivante
                        tryAllDownloadUrls(index + 1);
                    }
                })
                .catch(error => {
                    console.log('‚ùå URL invalide:', currentUrl);
                    // Essayer l'URL suivante
                    tryAllDownloadUrls(index + 1);
                });
        }

        function showManualDownloadOption() {
            downloadStatus.innerHTML = '‚ùå <strong>APK non disponible</strong>';
            manualDownload.style.display = 'block';
            
            // Lien vers la page GitHub des releases
            manualLink.href = 'https://github.com/nassimpublishing-dz/Hanafi-Map/releases';
            manualLink.target = '_blank';
            manualLink.onclick = function() {
                window.open(this.href, '_blank');
                return false;
            };
        }

        // Fermer la modale
        closeModal.addEventListener('click', () => {
            downloadModal.style.display = 'none';
        });

        // Fermer la banni√®re
        closeBanner.addEventListener('click', () => {
            console.log('‚ùå Banni√®re ferm√©e');
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerShown', 'true');
            
            // Re-proposer dans 7 jours
            const nextShow = new Date();
            nextShow.setDate(nextShow.getDate() + 7);
            localStorage.setItem('nextInstallPrompt', nextShow.getTime());
        });

        // V√©rifier si on doit afficher la banni√®re
        function shouldShowBanner() {
            const bannerShown = localStorage.getItem('installBannerShown');
            const nextPrompt = localStorage.getItem('nextInstallPrompt');
            
            if (bannerShown === 'true' && nextPrompt) {
                const now = new Date().getTime();
                return now >= parseInt(nextPrompt);
            }
            
            return bannerShown !== 'true';
        }

        // D√©tection de l'installation r√©ussie
        window.addEventListener('appinstalled', () => {
            console.log('üéâ Application install√©e avec succ√®s !');
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerShown', 'true');
        });

        // Fonction de notification temporaire
        function showTempNotification(message, duration = 3000) {
            const notification = document.createElement("div");
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #007bff;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideDown 0.3s ease-out;
                text-align: center;
                max-width: 90%;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // Initialisation au chargement
        window.addEventListener('load', () => {
            console.log('üöÄ Application charg√©e - V√©rification installation');
            
            if (isMobileDevice() && !isAppInstalled() && shouldShowBanner()) {
                // Afficher apr√®s 3 secondes
                setTimeout(showInstallBanner, 3000);
            }
            
            // Si pas de banni√®re PWA apr√®s 5 secondes, proposer l'APK
            setTimeout(() => {
                if (isMobileDevice() && !isAppInstalled() && !deferredPrompt && shouldShowBanner()) {
                    console.log('üì± Aucune PWA disponible - Proposition APK');
                    showInstallBanner();
                }
            }, 5000);
        });

        // Fonction pour forcer l'affichage de la banni√®re (pour tests)
        window.showInstallPrompt = function() {
            showInstallBanner();
        };

        // Fonction pour tester le t√©l√©chargement
        window.testDownload = function() {
            startAutomaticDownload();
        };
    </script>

    <!-- Charger Leaflet et votre app.js -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="app.js"></script>
</body>
</html>
